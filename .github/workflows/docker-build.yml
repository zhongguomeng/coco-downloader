name: Build Docker Image and Export as Artifact

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      image_name: ${{ steps.tag.outputs.image_name }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Generate image tag
      id: tag
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
        elif [[ "${{ github.ref }}" == refs/heads/* ]]; then
          TAG=${GITHUB_REF#refs/heads/}
          TAG=${TAG//\//-}
        else
          TAG="pr-${{ github.event.number }}"
        fi
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "image_name=coco-downloader:latest" >> $GITHUB_OUTPUT

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64
        push: false
        tags: ${{ steps.tag.outputs.image_name }}
        outputs: type=docker,dest=/tmp/coco-downloader.tar
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Upload Docker image as artifact
      uses: actions/upload-artifact@v4
      with:
        name: coco-downloader-${{ steps.tag.outputs.tag }}
        path: /tmp/coco-downloader.tar
        retention-days: 5

    - name: Generate download instructions
      run: |
        echo "## ğŸ³ Docker Image Built Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ Download and Load Instructions:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **ä¸‹è½½å·¥ä»¶**: åœ¨GitHub Actionsé¡µé¢ç‚¹å‡» \`coco-downloader-${{ steps.tag.outputs.tag }}\` ä¸‹è½½taræ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "2. **åŠ è½½å’Œè¿è¡Œé•œåƒ**:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# åŠ è½½é•œåƒåˆ°Docker" >> $GITHUB_STEP_SUMMARY
        echo "docker load -i coco-downloader.tar" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# è¿è¡Œå®¹å™¨" >> $GITHUB_STEP_SUMMARY
        echo "docker run -d -p 3000:3000 --name coco-downloader ${{ steps.tag.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# æ£€æŸ¥è¿è¡ŒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "curl http://localhost:3000" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ é•œåƒä¿¡æ¯:" >> $GITHUB_STEP_SUMMARY
        echo "- **é•œåƒåç§°**: ${{ steps.tag.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºåˆ†æ”¯/æ ‡ç­¾**: ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¹³å°**: linux/amd64" >> $GITHUB_STEP_SUMMARY

  test:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download Docker image artifact
      uses: actions/download-artifact@v4
      with:
        name: coco-downloader-${{ needs.build.outputs.tag }}
        path: /tmp

    - name: Load and test Docker image
      run: |
        # åŠ è½½é•œåƒ
        docker load -i /tmp/coco-downloader.tar
        
        # è·å–é•œåƒåç§°
        IMAGE_NAME=$(docker images --format "table {{.Repository}}:{{.Tag}}" | grep coco-downloader | head -1)
        echo "Testing image: $IMAGE_NAME"
        
        # è¿è¡Œå®¹å™¨
        docker run -d -p 3000:3000 --name test-container $IMAGE_NAME
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨ (Next.js å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ç¼–è¯‘/å¯åŠ¨)
        sleep 30
        
        # æµ‹è¯•æ ¹ç«¯ç‚¹
        curl -v http://localhost:3000/ || exit 1
        
        # æ¸…ç†
        docker stop test-container
        docker rm test-container
        
        echo "âœ… Dockeré•œåƒæµ‹è¯•é€šè¿‡!"
